<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Rui Liang</title>
		<script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://d3js.org/topojson.v1.min.js"></script>
		<style type="text/css">

			text {
				font-family: sans-serif;
				font-size: 12px;
				fill: white;
			}

		</style>
	</head>
	<body>
		<input id="slider" type="range" min="1960" max="2014" step = "1" value="1960"/>
		<form>
		  <label><input type="radio" name="dataset" value="2000" checked> 2000</label>
		  <label><input type="radio" name="dataset" value="2005"> 2005</label>
		</form>
		

		<p>
			<div id="problem4">
				<script>

				</script>
			</div>
		</p>

		<script type="text/javascript">

			//Width and height
			var pieChart = function(year) {
				

				var w = 300;
				var h = 300;

				d3.json("co2_gdpData.json", function (error, data) {
					if (error){console.log(error);}

					var countryData = data;
					var yearData = "y" + String(year);
          			var gdpData = "g" + String(year);
      
          			var piechartData = [];
          			var quintileData = [];
          			var mapData = {};

          			countryData.forEach(function (data) {
			           	
			            if(data[yearData]!=0) {
			            	piechartData.push(data[gdpData]);
			            	quintileData.push(data[gdpData]);
			            	mapData[data.CountryID] = {name: data.CountryName, id: data.CountryID, gdp: data[gdpData]};
			            };
			        });
          			// console.log(mapData, Object.keys(mapData).length);
          		
          		//sort quintileData JSON by gdp, code from http://stackoverflow.com/questions/979256/sorting-an-array-of-javascript-objects
				var sort_by = function(field, reverse, primer){

				   var key = primer ? 
				       function(x) {return primer(x[field])} : 
				       function(x) {return x[field]};

				   reverse = !reverse ? 1 : -1;

				   return function (a, b) {
				       return a = key(a), b = key(b), reverse * ((a > b) - (b > a));
				     } 
				}

				// quintileData.sort(sort_by("gdp", false, parseInt));
				quintileData.sort();
				console.log(quintileData);		

				// calculate the 20, 40, 60, 80 percentile, code from http://stackoverflow.com/questions/31572725/calculate-quintiles-deciles-from-an-array-of-numbers
				var len =  quintileData.length;
				var per20 =  quintileData[Math.floor(len*.2) - 1];
				var per40 =  quintileData[Math.floor(len*.4) - 1];
				var per60 =  quintileData[Math.floor(len*.6) - 1];
				var per80 =  quintileData[Math.floor(len*.8) - 1];

				// console.log("20",per20,"40",per40,"60",per60,"80",per80);
				quintileData.forEach(function (data) {
					quintileData.color = function() {
						var colorchoice = ["#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"];
						return color[Math.floor(Math.random()*5)];
					}

				})
				
				var colors = ["#eff3ff","#08519c"];
        		var colorScale = d3.scale.linear().domain([0, Math.log(Math.max.apply(null, quintileData))]).range(colors);

				var svgwidth = 960;
				var svgheight = 480;
				var svgpadding = 25;
				var outputofP4 = d3.select("#problem4").append("svg").attr("width", svgwidth).attr("height", svgheight);

				var projection = d3.geo.equirectangular();
				var path = d3.geo.path().projection(projection);
		

				var g = outputofP4.append("g");
				var worldObjects;

				d3.json("world-50m.json", function(error, world) {
					worldObjects = world;
					if (error) { console.log(error);}
					var countries = topojson.feature(world, world.objects.countries).features;

					countries.forEach(function (country) {
							
						g.append("path").attr("d", path(country)).style("fill", function(){
								if (mapData[country.id] == null) {
									return "ffffff"
								} else {
									return colorScale(Math.log(mapData[country.id].gdp));
									// if (mapData[country.id].gdp <= per20) {
									// 	return "#eff3ff"
									// } else if (mapData[country.id].gdp <= per40) {
									// 	return "#bdd7e7"
									// } else if (mapData[country.id].gdp <= per60) {
									// 	return "#6baed6"
									// } else if (mapData[country.id].gdp <= per80) {
									// 	return "#3182bd"
									// } else {
									// 	return "#08519c"
									// }
								}
							}
							
						).style("stroke", "#888");
						
					});

				});

				var outerRadius = w / 2;
				var innerRadius = 0;
				var arc = d3.svg.arc()
								.innerRadius(innerRadius)
								.outerRadius(outerRadius);
				
				var pie = d3.layout.pie();
				
				//Easy colors accessible via a 10-step ordinal scale
				var color = d3.scale.category10();

				//Create SVG element
				var svg = d3.select("#problem4")
							.append("svg")
							.attr("width", w)
							.attr("height", h);
				
				//Set up groups
				var arcs = svg.selectAll("g.arc")
							  .data(pie(piechartData))
							  .enter()
							  .append("g")
							  .attr("class", "arc")
							  .attr("transform", "translate(" + outerRadius + "," + outerRadius + ")");
				
				//Draw arc paths
				arcs.append("path")
				    .attr("fill", function(d, i) {
				    	return color(i);
				    })
				    .attr("d", arc);
				
				//Labels
				// arcs.append("text")
				//     .attr("transform", function(d) {
				//     	return "translate(" + arc.centroid(d) + ")";
				//     })
				//     .attr("text-anchor", "middle")
				//     .text(function(d) {
				//     	return d.value;
				//     });
				});
			};

			pieChart(2014)	
			// var slider = document.getElementById("slider");
			// console.log(slider.value);
			// slider.onchange = function () {
			// 	pieChart(slider.value)
			// };
			// var x = 1960;
			// setInterval(function() {
			// 	pieChart(x);
			// 	x++;
			// 	console.log(x)			},2000)
		</script>
	</body>
</html>